#!/bin/bash
set -eou pipefail
SCRIPTNAME="${0##*/}"
function error() {
    echo -n "$SCRIPTNAME: ERROR occured in line $1: "
    shift
    echo "$@"
}
if ((EUID != 0)); then
    error $LINENO "You need to be running as root."
    exit 253
fi

MYNAME="${SCRIPTNAME%.*}"
DATE=$(date -Iseconds | sed 's/:/-/g')
IMG="${1:-2020-05-27-raspios-buster-lite-armhf.img}"
BASE="${IMG%%.img}"
LOG=$MYNAME-$DATE-$BASE
STATS=$LOG-stats.log
export TIME="\ncommand: %C\nexit status %x, time measured: %Uuser %Ssystem %Eelapsed %PCPU"
{
    echo "Running $LOG with $(pishrink.sh | head -n 1)" | tee "$STATS"
    echo "on $(uname -a)" | tee -a "$STATS"

    options='z za Z Za'
    for run in $options; do
        env time -ao "$STATS" pishrink.sh -dv"$run" "$BASE".img "$BASE-$run".img
        mv pishrink.log "$BASE-$run".log
    done

    # override implicit options
    export PISHRINK_GZIP='-v1'
    export PISHRINK_XZ='-fv0T0'
    for run in $options; do
        env time -ao "$STATS" pishrink.sh -dv"$run" "$BASE".img "$BASE-$run"-env.img
        mv pishrink.log "$BASE-$run".log
    done

    ls -hltS "$BASE"-*.img.* | tee -a "$STATS"
} &> >(tee -a "$LOG".log)
