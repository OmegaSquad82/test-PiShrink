#!/bin/bash
set -eou pipefail
SCRIPTNAME="${0##*/}"
function error() {
	echo -n "$SCRIPTNAME: ERROR occured in line $1: "
	shift
	echo "$@"
}
if ((EUID != 0)); then
	error $LINENO "You need to be running as root."
	exit 253
fi

MYNAME="${SCRIPTNAME%.*}"
DATETIME=$(date -Iseconds)
DATE=${DATETIME//:/-}
IMG="${1:-2020-05-27-raspios-buster-lite-armhf.img}"
BASE="${IMG%%.img}"
LOG=$MYNAME-$DATE-$BASE
STATS=$LOG-results.md
OPT='d'
export TIME="\n#### %C\n\n- time measured: %Uuser %Ssystem %Eelapsed %PCPU"
{
	echo "# test results

- Started: $DATETIME
- Version: $(pishrink.sh | head -n 1)

## sysinfo

- Distribution: $(lsb_release -ds)
- Kernel: $(uname -s)
	- Release: $(uname -r)
	- Version: $(uname -v)
	- Machine: $(uname -m)

## $SCRIPTNAME

### executions" | tee -a "$STATS"

	options='zc z zC zac za zaC Zac Za ZaC Zaec Zae ZaeC' # if https://github.com/Drewsif/PiShrink/pull/154 merged
	for run in $options; do
		env time -ao "$STATS" pishrink.sh -"$OPT$run" "$BASE".img "$BASE-$run".img
		[[ -f pishrink.log ]] && echo "- $(grep 'Shrunk' pishrink.log)" >>"$STATS" && mv pishrink.log "$BASE-$run".log
	done

	# override implicit options
	export PISHRINK_GZIP='-v1'
	export PISHRINK_XZ='-fv0T0'
	for run in 'z' 'Z'; do
		env time -ao "$STATS" pishrink.sh -"$OPT$run" "$BASE".img "$BASE-$run"-env.img
		[[ -f pishrink.log ]] && echo "- $(grep 'Shrunk' pishrink.log)" >>"$STATS" && mv pishrink.log "$BASE-$run"-env.log
	done

	echo "

### archives by size:

\`\`\`bash
$(ls -hlS "$BASE"-*.img.*)
\`\`\`
" | tee -a "$STATS"
} &> >(tee -a "$LOG".log)
